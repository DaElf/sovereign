- name: Install Postfix and related packages
  apt:
    state: present
    name:
      - libsasl2-modules
      - postfix
      - postfix-pcre
      - postfix-pgsql
      - postgrey
      - python3-psycopg2
      - sasl2-bin
      - postfixadmin
      - php7.3-pgsql
  tags:
    - dependencies

#- name: Create database user for mail server
  postgresql_user: >-
    login_host=localhost
    login_user={{ db_admin_username }}
    login_password="{{ db_admin_password }}"
    name={{ mail_db_username }}
    password="{{ mail_db_password }}"
    encrypted=yes
    state=present
#  notify: import sql postfix

#- name: Create database for mail server
  postgresql_db: >-
    login_host=localhost
    login_user={{ db_admin_username }}
    login_password="{{ db_admin_password }}"
    name={{ mail_db_database }}
    state=present
    owner={{ mail_db_username }}
#  notify: import sql postfix

#- name: Copy import.sql
#  template: src=mailserver.sql.j2 dest=/etc/postfix/import.sql owner=root group=root mode=0600
#  notify: import sql postfix

- name: Create postfix maps directory
  file: path=/etc/postfix/maps state=directory owner=root group=root
  when: mail_header_privacy == 1

- name: Copy smtp_header_checks.pcre
  copy: >-
    src=etc_postfix_maps_smtp_header_checks.pcre
    dest=/etc/postfix/maps/smtp_header_checks.pcre
    owner=root
    group=root
  when: mail_header_privacy == 1

- name: Copy main.cf
  template: src=etc_postfix_main.cf.j2 dest=/etc/postfix/main.cf owner=root group=root
  notify: restart postfix

- name: Copy master.cf
  copy: src=etc_postfix_master.cf dest=/etc/postfix/master.cf owner=root group=root
  notify: restart postfix

- name: Copy additional postfix configuration files
  template: src=etc_postfix_{{ item }}.j2 dest=/etc/postfix/{{ item }} owner=root group=root
  with_items:
    - pgsql-virtual-alias-maps.cf
    - pgsql-virtual-mailbox-domains.cf
    - pgsql-virtual-mailbox-maps.cf
    - pgsql-virtual-mailbox-limits.cf
    - pgsql-virtual-domains-maps.cf
    - pgsql-relay-domains.cf

  notify: restart postfix

# Postfix admin stuff
# This should maybe conditonal in the case of ngnix

- name: Fix postfixadmin alias
  lineinfile:
    path: /etc/apache2/conf-available/postfixadmin.conf
    regexp: '^Alias'
    line: 'Alias /postfixadmin /usr/share/postfixadmin/public'

- name: Fix 'support_tools' permissions
  file: path=/usr/share/postfixadmin/public owner=www-data group=www-data state=directory recurse=yes


- name: enable postfixadmin config in apache
  command: a2enconf postfixadmin creates=/etc/apache2/conf-enabled/postfixadmin.conf
  notify: restart apache

- name: create postfixadmin template_c dir
  file: state=directory path=/usr/share/postfixadmin/templates_c group=www-data owner=www-data

#- name: Copy dbconfig-common/postfixadmin.conf
#  copy: src=etc_dbconfig-common_postfixadmin.conf dest=/etc/dbconfig-common/postfixadmin.conf owner=root group=root

- name: Copy /etc/postfixadmin/dbconfig.inc.php
  copy: src=etc_postfixadmin_dbconfig.inc.php dest=/etc/postfixadmin/dbconfig.inc.php owner=root group=root

- name: Create postgres "postfixadmin" database
  become: true
  become_user: postgres
  postgresql_db:
    name: postfixadmin

- name: Set password for PostgreSQL postfixadmin user
  become: true
  become_user: postgres
  postgresql_user:
    db: postfixadmin
    name: postfixadmin
    password: postfixadmin

# End postfix admin

#- name: Setup postfixadmin config.local
#  template: src=config.local.php.j2 dest=/usr/share/postfixadmin/config.local.php  group=www-data owner=www-data

- name: Set firewall rules for postfix
  ufw: rule=allow port={{ item }} proto=tcp
  with_items:
    - smtp
    - ssmtp
    - submission
    - sieve
  tags: ufw
